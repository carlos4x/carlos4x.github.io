<!--
  H2O Prime Water Consultation Landing Page
  
  This interactive landing page was adapted from a travel consultation template.
  It collects customer information for water filtration services through a
  conversational interface and sends the data to n8n workflows.
  
  Features:
  - Multi-step form with validation
  - Confirmation summary before submission
  - Water system type selection
  - Integration with n8n webhook
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>H2O Prime | Premium Water Filtration Solutions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Force cache invalidation with version parameter -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Add a timestamp to force browsers to recognize this as a new page -->
    <meta name="version" content="v2.0.<?php echo time(); ?>">
    <style>
        :root {
            --primary-color: #0073CF;
            --primary-light: #47A9FF;
            --primary-dark: #005AA3;
            --secondary-color: #728F63; /* Earthy green instead of teal */
            --accent-color: #B8845F; /* Warm wood tone for accents */
            --text-color: #1F2937;
            --text-light: #6B7280;
            --background-color: #F7F5F0; /* Slightly off-white for a natural paper feel */
            --white: #FFFFFF;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 16px;
            --vh: 1vh; /* Custom property for iOS height fix */
            --wood-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+CiAgPGRlZnM+CiAgICA8cGF0dGVybiBpZD0id29vZCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiPgogICAgICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0icmdiYSgxODQsMTMyLDk1LDAuMDgpIi8+CiAgICAgIDxnIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgxNjQsMTE3LDgwLDAuMDQpIiBzdHJva2Utd2lkdGg9IjEuNSI+CiAgICAgICAgPHBhdGggZD0iTTAgMCBMIDIwMCAyMDAiLz4KICAgICAgICA8cGF0aCBkPSJNMTAwIDAgTCAyMDAgMTAwIi8+CiAgICAgICAgPHBhdGggZD0iTTAgMTAwIEwgMTAwIDIwMCIvPgogICAgICAgIDxwYXRoIGQ9Ik01MCAwIEwgMjAwIDE1MCIvPgogICAgICAgIDxwYXRoIGQ9Ik0wIDUwIEwgMTUwIDIwMCIvPgogICAgICAgIDxwYXRoIGQ9Ik0xNTAgMCBMIDIwMCA1MCIvPgogICAgICAgIDxwYXRoIGQ9Ik0wIDE1MCBMIDU0IDIwMCIvPgogICAgICA8L2c+CiAgICA8L3BhdHRlcm4+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjd29vZCkiLz4KPC9zdmc+');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center; /* Ensure proper centering */
            overflow: hidden;
            /* Add subtle texture to body background */
            background-image: var(--wood-texture);
            background-repeat: repeat;
            margin: 0; /* Remove any default margins */
            padding: 0; /* Remove any default padding */
        }

        /* Language selector styles */
        .language-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .language-selector-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            /* Add subtle texture */
            background-image: var(--wood-texture);
            border: 1px solid rgba(184, 132, 95, 0.2);
        }

        .language-selector-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .language-selector-description {
            font-size: 1rem;
            margin-bottom: 2rem;
            color: var(--text-light);
        }

        .language-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .language-button {
            padding: 0.75rem 1.5rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
        }

        .lang-en {
            background-color: var(--primary-color);
            color: var(--white);
            border: 1px solid var(--primary-color);
        }

        .lang-en:hover {
            background-color: var(--primary-dark);
        }

        .lang-es {
            background-color: var(--white);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .lang-es:hover {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .language-flag {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Hide all content initially */
        .content-container {
            display: none; /* Initially hidden */
        }

        /* When content is visible */
        .content-container.visible {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        /* Container styling */
        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            /* Add subtle border */
            border: 1px solid rgba(184, 132, 95, 0.2);
            margin: 0 auto; /* Ensure horizontal centering */
        }

        /* Sidebar layout */
        .sidebar {
            width: 38%; /* Increased width for more prominence */
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-width: 300px; /* Ensure minimum width */
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(20deg);
            z-index: 0;
        }

        /* Add subtle wood grain texture overlay to sidebar */
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--wood-texture);
            opacity: 0.05;
            z-index: 0;
        }

        .sidebar-content {
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 2rem; /* Larger logo */
            font-weight: 700;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); /* Add subtle text shadow */
            letter-spacing: 0.5px; /* Slight letter spacing for rustic feel */
        }

        .tagline {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15); /* Add subtle text shadow */
        }

        .description {
            font-size: 1.1rem; /* Slightly larger for better readability */
            font-weight: 400;
            line-height: 1.6;
            margin-bottom: 2rem;
            letter-spacing: 0.2px; /* Slight letter spacing for rustic feel */
        }

        .features {
            margin-top: auto;
            background-color: rgba(0, 0, 0, 0.1); /* Semi-transparent background */
            padding: 1.2rem;
            border-radius: 12px;
            border-left: 3px solid var(--secondary-color); /* Earthy green accent border */
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .feature-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
        }

        .feature-text {
            font-size: 0.9rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .chat-container {
            width: 62%; /* Adjusted width to match sidebar increase */
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            /* Add very subtle texture */
            background-image: var(--wood-texture);
            background-repeat: repeat;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(184, 132, 95, 0.2); /* Rustic border color */
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent */
        }

        .chat-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: 0.2px; /* Slight letter spacing for rustic feel */
        }

        .chat-status {
            font-size: 0.875rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            margin-right: 6px;
        }

        .chat-body {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .agent-message {
            align-self: flex-start;
        }

        .user-message {
            align-self: flex-end;
        }

        .message-content {
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            line-height: 1.5;
        }

        .agent-message .message-content {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-bottom-left-radius: 4px;
            border-left: 2px solid var(--secondary-color); /* Earthy green accent */
        }
        
        .error-message {
            background-color: #FEF2F2 !important;
            border: 1px solid #FCA5A5 !important;
            color: #B91C1C;
            font-style: italic;
        }

        .user-message .message-content {
            background-color: var(--primary-color);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            align-self: flex-start;
            background-color: #F9FAFB;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            margin-bottom: 1.5rem;
            display: none;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-light);
            border-radius: 50%;
            margin-right: 5px;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
            margin-right: 0;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .chat-input-container {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(184, 132, 95, 0.2); /* Rustic border color */
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent */
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 999px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 115, 207, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.5rem 0;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
        }

        .chat-input:focus {
            outline: none;
        }

        .send-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background-color: var(--primary-dark);
        }

        .send-button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
        }

        .send-icon {
            width: 18px;
            height: 18px;
        }

        /* Options component for multiple choice */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .option-button {
            background-color: var(--white);
            border: 1px solid var(--primary-light);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-button:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }

        /* Add rustic styling to confirmation summary */
        .confirmation-summary {
            background-color: #F9FAFB;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary-color); /* Use earthy green */
            background-image: var(--wood-texture);
        }

        .confirmation-item {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .confirmation-label {
            font-weight: 600;
            color: var(--accent-color); /* Use wood tone for labels */
            min-width: 120px;
            margin-right: 10px;
        }

        .confirmation-value {
            color: var(--text-color);
            flex: 1;
            word-break: break-word;
        }

        /* Calendar picker styles with rustic accents */
        .calendar-picker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
            max-width: 350px;
            border: 1px solid rgba(184, 132, 95, 0.2);
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.6);
        }

        .day-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
            border-color: var(--primary-dark);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                width: 100%;
                border-radius: 0;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 1.5rem;
                max-height: 60vh; /* Limit sidebar height on mobile */
                overflow-y: auto; /* Allow scrolling within sidebar if needed */
            }

            .chat-container {
                width: 100%;
                height: auto; /* Allow chat container to expand */
                min-height: 40vh; /* Ensure chat area is visible */
            }

            .tagline {
                font-size: 1.5rem;
            }

            .features {
                display: block; /* Keep features visible on mobile */
                margin-bottom: 1rem;
            }
            
            /* Ensure the content container takes full height but allows scrolling */
            .content-container.visible {
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* iPhone-specific styles - make survey form more prominent */
        @media (max-width: 428px) {
            .sidebar {
                max-height: 30vh; /* Further limit sidebar height on iPhone */
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .tagline {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            
            .description {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .features {
                display: none; /* Hide features on iPhone */
            }
            
            .chat-container {
                min-height: 70vh; /* Make chat container take more space */
            }
            
            .chat-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #ffffff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .chat-input-container {
                background-color: #ffffff;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            }
        }

        /* Preserve the additional responsive styles from the Water Consultant template */
        @media (max-width: 768px) {
            html, body {
                position: relative;
                overflow: auto; /* Allow scrolling */
                -webkit-overflow-scrolling: touch;
                height: 100%;
                width: 100%;
            }
            
            body {
                overflow-y: auto; /* Allow vertical scrolling */
            }
            
            /* Additional mobile fixes from the Water Consultant template */
            .chat-body {
                -webkit-overflow-scrolling: touch;
                padding-bottom: 70px; /* Ensure space for input area */
            }
            
            .chat-input-container {
                position: sticky;
                bottom: 0;
                background: white;
                width: 100%;
                z-index: 10;
                transform: translateZ(0); /* Fix iOS position:sticky issues */
            }
            
            /* Calendar picker mobile fixes */
            .calendar-picker {
                grid-template-columns: repeat(7, 1fr);
                width: 100%;
                max-width: 100%;
                gap: 3px;
            }
            
            .day-option {
                padding: 8px 2px;
                font-size: 0.7rem;
                min-height: 35px;
            }
            
            /* Clock picker mobile fixes */
            .clock-picker {
                width: 100%;
                max-width: 100%;
            }
            
            .time-option {
                padding: 6px 8px;
                font-size: 0.75rem;
                min-width: 45px;
                margin-bottom: 5px;
            }
            
            /* Improve tap targets on iOS */
            button, .option-button, .day-option, .time-option, .period-option {
                min-height: 44px; /* Apple's recommended minimum tap target size */
            }
            
            /* Prevent iOS zoom on input */
            input, select, textarea {
                font-size: 16px !important;
            }
            
            /* Fix options container on mobile */
            .options-container {
                flex-wrap: wrap;
                max-width: 100%;
            }
            
            .option-button {
                margin-bottom: 5px;
                white-space: normal;
                text-align: center;
                height: auto;
            }
            
            /* Fix message bubbles */
            .message {
                max-width: 90%;
            }
            
            /* Fix confirmation summary */
            .confirmation-summary {
                width: 100%;
                padding: 10px;
            }
            
            .confirmation-item {
                flex-direction: column;
            }
            
            .confirmation-label {
                min-width: 100%;
                margin-bottom: 3px;
            }
            
            /* Hide sidebar when keyboard is likely open */
            @media (max-height: 500px) {
                .sidebar {
                    display: none;
                }
                
                .chat-container {
                    height: 100vh;
                }
            }
        }

        /* Correction messages */
        .correction-message {
            background-color: #E8F4FD;
            border: 1px solid #B3E0FF;
            color: #0075CC;
            font-style: italic;
            font-size: 0.9em;
        }

        /* Calendar picker styles */
        .calendar-picker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
            max-width: 350px;
        }

        .day-option {
            padding: 10px 5px;
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--white);
            color: var(--primary-color);
            font-size: 0.8rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-option:hover {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .day-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }

        .day-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        /* Clock picker styles */
        .clock-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            max-width: 350px;
        }

        .time-option {
            padding: 8px 12px;
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--white);
            color: var(--primary-color);
            font-size: 0.8rem;
            min-width: 60px;
        }

        .time-option:hover {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .time-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }
        
        .time-option.suggested {
            background-color: #E8F4FD;
            border-color: var(--primary-color);
            border-width: 2px;
        }

        .time-period {
            display: flex;
            width: 100%;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .period-option {
            padding: 5px 15px;
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--white);
            color: var(--primary-color);
            font-size: 0.8rem;
            min-width: 60px;
        }

        .period-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
        }
        
        .time-suggestion-hint {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 10px;
            font-style: italic;
            text-align: center;
        }
    </style>

    <!-- Add a wood grain SVG pattern for texture -->
    <svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
        <defs>
            <pattern id="wood-pattern" width="200" height="200" patternUnits="userSpaceOnUse">
                <rect width="200" height="200" fill="rgba(184,132,95,0.05)"/>
                <g fill="none" stroke="rgba(164,117,80,0.04)" stroke-width="1.5">
                    <path d="M0 0 L 200 200"/>
                    <path d="M100 0 L 200 100"/>
                    <path d="M0 100 L 100 200"/>
                    <path d="M50 0 L 200 150"/>
                    <path d="M0 50 L 150 200"/>
                    <path d="M150 0 L 200 50"/>
                    <path d="M0 150 L 54 200"/>
                </g>
            </pattern>
        </defs>
    </svg>
</head>
<body>
    <!-- Language selector overlay -->
    <div class="language-selector-overlay" id="languageSelector">
        <div class="language-selector-container">
            <h2 class="language-selector-title">Choose Your Language / Elija su Idioma</h2>
            <p class="language-selector-description">Please select your preferred language to continue / Por favor seleccione su idioma preferido para continuar</p>
            <div class="language-buttons">
                <button class="language-button lang-en" onclick="selectLanguage('en')">
                    <span class="language-flag">🇺🇸</span>
                    English
                </button>
                <button class="language-button lang-es" onclick="selectLanguage('es')">
                    <span class="language-flag">🇪🇸</span>
                    Español
                </button>
            </div>
        </div>
    </div>

    <!-- Main content container (initially hidden) - English Version -->
    <div class="content-container" id="contentEN">
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="logo">H2O Prime</div>
                    <h1 class="tagline">Premium water solutions for your home</h1>
                    <p class="description">Chat with our water quality expert to schedule your free consultation and discover the perfect water filtration system for your home.</p>
                    <div class="features">
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Whole-home water softening systems</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Under-sink reverse osmosis filtration</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Free professional water quality testing</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Expert installation and maintenance</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">Water Consultation Expert</div>
                    <div class="chat-status">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                </div>

                <div class="chat-body" id="chatBody">
                    <!-- Messages will appear here -->
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off">
                        <button id="sendButton" class="send-button">
                            <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spanish content container (initially hidden) -->
    <div class="content-container" id="contentES">
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="logo">H2O Prime</div>
                    <h1 class="tagline">Soluciones premium de agua para tu hogar</h1>
                    <p class="description">Chatea con nuestro experto en calidad del agua para programar tu consulta gratuita y descubrir el sistema de filtración perfecto para tu hogar.</p>
                    <div class="features">
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Sistemas de ablandamiento de agua para toda la casa</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Filtración por ósmosis inversa bajo el fregadero</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Prueba profesional gratuita de calidad del agua</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">✓</div>
                            <div class="feature-text">Instalación y mantenimiento por expertos</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">Experto en Consulta de Agua</div>
                    <div class="chat-status">
                        <div class="status-dot"></div>
                        <span>En línea</span>
                    </div>
                </div>

                <div class="chat-body" id="chatBodyES">
                    <!-- Messages will appear here -->
                </div>

                <div class="typing-indicator" id="typingIndicatorES">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInputES" class="chat-input" placeholder="Escribe tu mensaje..." autocomplete="off">
                        <button id="sendButtonES" class="send-button">
                            <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language selection functionality
        function selectLanguage(lang) {
            // Hide language selector
            document.getElementById('languageSelector').style.display = 'none';
            
            // Show appropriate content
            if (lang === 'en') {
                const contentEN = document.getElementById('contentEN');
                contentEN.style.display = 'flex';
                contentEN.classList.add('visible');
                initializeChat('en');
            } else if (lang === 'es') {
                const contentES = document.getElementById('contentES');
                contentES.style.display = 'flex';
                contentES.classList.add('visible');
                initializeChat('es');
            }
            
            // Ensure sidebar is properly styled after content is visible
            setTimeout(function() {
                initializeSidebars();
                fixSidebarHeight();
                
                // Apply iPhone-specific fixes if needed
                if (/iPhone/.test(navigator.userAgent)) {
                    fixIPhoneLayout();
                    
                    // Force redraw of container structure
                    const containers = document.querySelectorAll('.container');
                    containers.forEach(container => {
                        // Trigger browser reflow
                        container.style.display = 'none';
                        container.offsetHeight; // Force reflow
                        container.style.display = 'flex';
                        
                        // Ensure chat container is visible and prominent
                        const chatContainer = container.querySelector('.chat-container');
                        if (chatContainer) {
                            chatContainer.style.display = 'flex';
                            chatContainer.style.flex = '1 1 auto';
                            chatContainer.style.minHeight = '70vh';
                        }
                        
                        // Make sidebar less prominent
                        const sidebar = container.querySelector('.sidebar');
                        if (sidebar) {
                            sidebar.style.maxHeight = '30vh';
                        }
                    });
                    
                    // Scroll to ensure chat area is visible and prominent
                    setTimeout(function() {
                        window.scrollTo(0, window.innerHeight * 0.25);
                    }, 300);
                }
            }, 50);
        }
        
        // Core DOM elements
        let chatBody, chatInput, sendButton, typingIndicator;
        
        // Form validation utilities
        const validators = {
            fullName: (value) => {
                const words = value.trim().split(/\s+/);
                return {
                    isValid: words.length >= 2 && words[0].length > 0 && words[1].length > 0,
                    errorMessage: "Please enter your full name (both first and last name).",
                    errorMessageES: "Por favor ingrese su nombre completo (nombre y apellido)."
                };
            },
            email: (value) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return {
                    isValid: emailRegex.test(value),
                    errorMessage: "Please enter a valid email address (e.g., name@example.com).",
                    errorMessageES: "Por favor ingrese un correo electrónico válido (ej., nombre@ejemplo.com)."
                };
            },
            phone: (value) => {
                const phoneRegex = /^[\d\s\(\)\-\+]{10,}$/;
                const digitsOnly = value.replace(/\D/g, '');
                return {
                    isValid: phoneRegex.test(value) && digitsOnly.length >= 10,
                    errorMessage: "Please enter a valid US phone number (e.g., 602-123-4567 or (602) 123-4567).",
                    errorMessageES: "Por favor ingrese un número de teléfono válido de EE.UU. (ej., 602-123-4567 o (602) 123-4567)."
                };
            },
            zipCode: (value) => {
                const zipRegex = /^\d{5}(-\d{4})?$/;
                return {
                    isValid: zipRegex.test(value),
                    errorMessage: "Please enter a valid 5-digit ZIP code (e.g., 12345).",
                    errorMessageES: "Por favor ingrese un código postal válido de 5 dígitos (ej., 12345)."
                };
            },
            address: (value) => {
                // Check for street type indicators and minimum length
                const streetTypeRegex = /\b(st|street|ave|avenue|blvd|boulevard|dr|drive|rd|road|ln|lane|way|place|pl|ct|court|circle|cir|terrace|ter)\b/i;
                
                // Check minimum length for a valid address
                const minLength = 8;
                
                // Make comma optional - we'll guide them to add it in the error message
                const isValid = value.length >= minLength && streetTypeRegex.test(value);
                
                return {
                    isValid: isValid,
                    errorMessage: "Please enter a complete address including street type (St, Ave, Rd, etc.) and city (e.g., 123 Main St, Phoenix).",
                    errorMessageES: "Por favor ingrese una dirección completa que incluya el tipo de calle (Calle, Ave, etc.) y la ciudad (ej., 123 Calle Principal, Phoenix)."
                };
            },
            required: (value) => {
                return {
                    isValid: value.trim().length > 0,
                    errorMessage: "This field is required. Please provide a response.",
                    errorMessageES: "Este campo es obligatorio. Por favor proporcione una respuesta."
                };
            }
        };
        
        // Common misspelling corrections
        const spellCorrections = {
            // Email domain corrections
            'gmail.con': 'gmail.com',
            'gmail.co': 'gmail.com',
            'gmail.cm': 'gmail.com',
            'gmail.om': 'gmail.com',
            'gmial.com': 'gmail.com',
            'gamil.com': 'gmail.com',
            'gmai.com': 'gmail.com',
            'gmal.com': 'gmail.com',
            'hotmail.con': 'hotmail.com',
            'hotmail.co': 'hotmail.com',
            'hotmail.cm': 'hotmail.com',
            'hotmail.om': 'hotmail.com',
            'hotmial.com': 'hotmail.com',
            'hotamail.com': 'hotmail.com',
            'hotmai.com': 'hotmail.com',
            'hotmal.com': 'hotmail.com',
            'yahoo.con': 'yahoo.com',
            'yahoo.co': 'yahoo.com',
            'yahoo.cm': 'yahoo.com',
            'yahoo.om': 'yahoo.com',
            'yaho.com': 'yahoo.com',
            'yahooo.com': 'yahoo.com',
            'yaoo.com': 'yahoo.com',
            'ymail.con': 'ymail.com',
            'ymail.co': 'ymail.com',
            'icloud.con': 'icloud.com',
            'icloud.co': 'icloud.com',
            'icloud.cm': 'icloud.com',
            'icoud.com': 'icloud.com',
            'outlook.con': 'outlook.com',
            'outlook.co': 'outlook.com',
            'outlook.cm': 'outlook.com',
            'outlok.com': 'outlook.com',
            'outook.com': 'outlook.com',
            'me.con': 'me.com',
            'me.cm': 'me.com',
            'me.co': 'me.com',
            'me.om': 'me.com',
            '.con': '.com',
            '.cmo': '.com',
            '.cm': '.com',
            '.om': '.com',
            
            // Common word misspellings in English
            'adress': 'address',
            'adres': 'address',
            'addres': 'address',
            'phne': 'phone',
            'fone': 'phone',
            'telephon': 'telephone',
            'mobil': 'mobile',
            'celular': 'cellular',
            'cel': 'cell',
            'zip': 'zip code',
            'postal': 'zip code',
            'code postal': 'zip code',
            'street': 'st',
            'avenue': 'ave',
            'road': 'rd',
            'boulevard': 'blvd',
            'appartment': 'apartment',
            'apt': 'apartment',
            
            // Common Spanish misspellings
            'direcion': 'dirección',
            'dirreción': 'dirección',
            'direcion': 'dirección',
            'correo electronico': 'correo electrónico',
            'coreo electrónico': 'correo electrónico',
            'coreo': 'correo',
            'telefono': 'teléfono',
            'cellular': 'celular',
            'movil': 'móvil',
            'cellular': 'celular',
            'celluar': 'celular',
            'codigo': 'código',
            'postal': 'código postal',
            'zip': 'código postal',
            'codigo postal': 'código postal',
            'callle': 'calle',
            'cale': 'calle',
            'avenida': 'ave',
            'ave.': 'ave',
            'apartamento': 'apto',
            'apartmento': 'apto',
            'apto.': 'apto',
            'communidad': 'comunidad',
            'proprietario': 'propietario',
            'dueño': 'propietario',
            'si': 'sí',
            'filtración': 'filtración',
            'filtracion': 'filtración',
            'osmosis': 'ósmosis',
            'osmósis': 'ósmosis'
        };
        
        // Function to correct common misspellings
        function correctSpelling(input) {
            if (!input) return input;
            
            // If we're in English mode, don't use any accented characters
            const isEnglish = questions === questionsEN;
            
            let corrected = input;
            
            // Check for email corrections
            if (corrected.includes('@')) {
                const [username, domain] = corrected.split('@');
                if (domain && spellCorrections[domain.toLowerCase()]) {
                    corrected = username + '@' + spellCorrections[domain.toLowerCase()];
                }
            }
            
            // Check for other word corrections
            const words = corrected.split(/\s+/);
            const correctedWords = words.map(word => {
                const lowerWord = word.toLowerCase();
                
                // If we're in English mode, make sure we don't use Spanish corrections
                if (isEnglish) {
                    // Only use English corrections (ones without accented characters)
                    const correction = spellCorrections[lowerWord];
                    if (correction && !hasAccentedCharacters(correction)) {
                        return correction;
                    }
                    return word;
                } else {
                    // In Spanish mode, use any correction
                    return spellCorrections[lowerWord] || word;
                }
            });
            
            // Only return the corrected string if something changed
            const newText = correctedWords.join(' ');
            return newText !== input ? newText : input;
        }
        
        // Helper function to detect accented characters
        function hasAccentedCharacters(str) {
            // This regex matches common accented characters in Spanish
            return /[áéíóúüñÁÉÍÓÚÜÑ]/.test(str);
        }
        
        // Webhook configuration
        const webhookUrl = 'http://localhost:3000/water-consultation';
        
        // Questions for water consultation form in English
        const questionsEN = [
            { 
                id: 'greeting',
                text: "Hi there! I'm your personal water quality expert from H2O Prime. I'll help you schedule a free water consultation to find the perfect filtration solution for your home. What's your full name (first and last name)?",
                field: 'Full Name',
                validation: 'fullName'
            },
            { 
                id: 'email',
                text: "Nice to meet you, {Full Name}! Please share your email address so we can send you details about your free water consultation.",
                field: 'Email',
                validation: 'email'
            },
            { 
                id: 'phone',
                text: "Great! What's the best phone number to reach you?",
                field: 'Phone Number',
                validation: 'phone'
            },
            {
                id: 'address',
                text: "Please provide your home address where you'd like to schedule the water consultation.",
                field: 'Address',
                validation: 'required'
            },
            {
                id: 'propertyOwner',
                text: "Are you the rightful property owner?",
                field: 'Property Owner',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'zipCode',
                    'No': 'zipCode'
                }
            },
            { 
                id: 'zipCode',
                text: "And what's your ZIP code?",
                field: 'Zip Code',
                validation: 'zipCode'
            },
            { 
                id: 'waterSource',
                text: "What is your current water source?",
                field: 'Water Source',
                options: ['City Water', 'Well Water', 'Community Well', 'Other'],
                validation: 'required'
            },
            { 
                id: 'lastInspection',
                text: "When was the last time you had your water quality checked?",
                field: 'Last Inspection',
                options: ['Never', 'Within last year', '1-5 years ago', '5+ years ago', 'Not sure']
            },
            { 
                id: 'interestedSystem',
                text: "What water filtration systems do you currently have at home?",
                field: 'Current System',
                options: ['Whole House Water Softener', 'Under-Sink Reverse Osmosis', 'Both', 'None', 'Not sure']
            },
            { 
                id: 'filterReplacement',
                text: "When was the last time your water filters were replaced?",
                field: 'Filter Replacement',
                options: ['Never', 'Within last year', '1-5 years ago', '5+ years ago', 'Not sure']
            },
            { 
                id: 'cookingWater',
                text: "What kind of water is used for cooking?",
                field: 'Cooking Water',
                options: ['Unfiltered Tap Water', '5g Water bottles delivery', '5g Water at Store', 'Bottled water from market', 'Britta or other counter filters', 'Other']
            },
            { 
                id: 'drinkingWater',
                text: "What kind of water is used for drinking?",
                field: 'Drinking Water',
                options: ['Unfiltered Tap Water', '5g Water bottles delivery', '5g Water at Store', 'Bottled water from market', 'Britta or other counter filters', 'Other']
            },
            { 
                id: 'waterIssues',
                text: "Are you experiencing any of these common water issues? Select all that apply.",
                field: 'Water Issues',
                multiselect: true,
                options: ['Hard water/scaling', 'Bad taste/odor', 'Staining on fixtures', 'Sediment/particles', 'Health concerns', 'High water bills', 'Hair loss', 'Dry or itchy skin', 'Acne', 'Psoriasis', 'None of these']
            },
            { 
                id: 'concerns',
                text: "Do you have any specific concerns about your water quality that you'd like us to address during your consultation?",
                field: 'Has Concerns',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'concernsDetails',
                    'No': 'confirmationSummary'
                }
            },
            { 
                id: 'concernsDetails',
                text: "Please describe your specific water quality concerns:",
                field: 'Water Concerns'
            },
            {
                id: 'confirmationSummary',
                text: "Great! Here's a summary of your information. Please confirm these details are correct:",
                field: 'Confirmation',
                isConfirmation: true,
                options: ['Yes, schedule my consultation', 'No, I need to make changes']
            },
            {
                id: 'whatToChange',
                text: "Which information would you like to correct? Select all that apply:",
                field: 'Information to Correct',
                multiselect: true,
                options: ['Full Name', 'Email', 'Phone Number', 'Address', 'Zip Code', 'Water Source']
            },
            { 
                id: 'preferredDay',
                text: "What day works best for your water consultation?",
                field: 'Preferred Day',
                isCalendarPicker: true,
                options: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
            },
            { 
                id: 'preferredTimeOfDay',
                text: "What time of day works best for our water technician expert to visit?",
                field: 'Preferred Time of Day',
                options: ['Morning', 'Afternoon', 'Evening']
            },
            { 
                id: 'preferredHour',
                text: "What specific hour would be most convenient? (Please pick a time between 7 AM to 10 PM)",
                field: 'Preferred Hour',
                isClockPicker: true,
                validation: 'required'
            },
            { 
                id: 'final',
                text: "Thank you, {Full Name}! Your free water consultation will be verified soon. One of our water technician experts will contact you within the next hour(s) to confirm your preferred time ({Preferred Day} at {Preferred Hour}). We've sent a confirmation email to {Email} with more information about what to expect and to verify your free water consultation . Please check your email to receive your Personalized Water Quality Report for your area. If you have any immediate questions, please call us at (602) 721-2929.",
                field: 'Final'
            }
        ];
        
        // Questions for water consultation form in Spanish
        const questionsES = [
            { 
                id: 'greeting',
                text: "¡Hola! Soy tu experto personal en calidad del agua de H2O Prime. Te ayudaré a programar una consulta gratuita para encontrar la solución de filtración perfecta para tu hogar. ¿Cuál es tu nombre completo (nombre y apellido)?",
                field: 'Nombre Completo',
                validation: 'fullName'
            },
            { 
                id: 'email',
                text: "¡Encantado de conocerte, {Nombre Completo}! Por favor, comparte tu dirección de correo electrónico para que podamos enviarte detalles sobre tu consulta gratuita.",
                field: 'Correo Electrónico',
                validation: 'email'
            },
            { 
                id: 'phone',
                text: "¡Excelente! ¿Cuál es el mejor número de teléfono para contactarte?",
                field: 'Número de Teléfono',
                validation: 'phone'
            },
            {
                id: 'address',
                text: "Por favor, proporciona la dirección de tu casa donde te gustaría programar la consulta sobre el agua.",
                field: 'Dirección',
                validation: 'required'
            },
            {
                id: 'propertyOwner',
                text: "¿Eres el propietario legítimo de la propiedad?",
                field: 'Propietario',
                options: ['Sí', 'No'],
                nextQuestionBranch: {
                    'Sí': 'zipCode',
                    'No': 'zipCode'
                }
            },
            { 
                id: 'zipCode',
                text: "¿Y cuál es tu código postal?",
                field: 'Código Postal',
                validation: 'zipCode'
            },
            { 
                id: 'waterSource',
                text: "¿Cuál es tu fuente de agua actual?",
                field: 'Fuente de Agua',
                options: ['Agua de la Ciudad', 'Agua de Pozo', 'Pozo Comunitario', 'Otro'],
                validation: 'required'
            },
            { 
                id: 'lastInspection',
                text: "¿Cuándo fue la última vez que verificaste la calidad de tu agua?",
                field: 'Última Inspección',
                options: ['Nunca', 'En el último año', 'Hace 1-5 años', 'Hace más de 5 años', 'No estoy seguro']
            },
            { 
                id: 'interestedSystem',
                text: "¿Qué sistemas de filtración de agua tienes actualmente en casa?",
                field: 'Sistema Actual',
                options: ['Ablandador de Agua para Toda la Casa', 'Ósmosis Inversa Bajo el Fregadero', 'Ambos', 'Ninguno', 'No estoy seguro']
            },
            { 
                id: 'filterReplacement',
                text: "¿Cuándo fue la última vez que reemplazaste tus filtros de agua?",
                field: 'Reemplazo de Filtro',
                options: ['Nunca', 'En el último año', 'Hace 1-5 años', 'Hace más de 5 años', 'No estoy seguro']
            },
            { 
                id: 'cookingWater',
                text: "¿Qué tipo de agua se utiliza para cocinar?",
                field: 'Agua de Cocina',
                options: ['Agua del Grifo Sin Filtrar', '5g Botellas de Agua', '5g Agua en Tienda', 'Agua Embotellada de Mercado', 'Britta o Filtros de Contador', 'Otro']
            },
            { 
                id: 'drinkingWater',
                text: "¿Qué tipo de agua se utiliza para beber?",
                field: 'Agua de Beber',
                options: ['Agua del Grifo Sin Filtrar', '5g Botellas de Agua', '5g Agua en Tienda', 'Agua Embotellada de Mercado', 'Britta o Filtros de Contador', 'Otro']
            },
            { 
                id: 'waterIssues',
                text: "¿Estás experimentando alguno de estos problemas comunes del agua? Selecciona todos los que apliquen.",
                field: 'Problemas del Agua',
                multiselect: true,
                options: ['Agua dura/incrustaciones', 'Mal sabor/olor', 'Manchas en los accesorios', 'Sedimentos/partículas', 'Preocupaciones de salud', 'Facturas de agua altas', 'Caída del cabello', 'Piel seca o con picazón', 'Acné', 'Psoriasis', 'Ninguno de estos']
            },
            { 
                id: 'concerns',
                text: "¿Tienes alguna preocupación específica sobre la calidad de tu agua que te gustaría que abordemos durante tu consulta?",
                field: 'Tiene Preocupaciones',
                options: ['Sí', 'No'],
                nextQuestionBranch: {
                    'Sí': 'concernsDetails',
                    'No': 'confirmationSummary'
                }
            },
            { 
                id: 'concernsDetails',
                text: "Por favor, describe sus preocupaciones específicas sobre la calidad del agua:",
                field: 'Preocupaciones del Agua'
            },
            {
                id: 'confirmationSummary',
                text: "¡Genial! Aquí tienes un resumen de tu información. Por favor, confirma que estos detalles son correctos:",
                field: 'Confirmación',
                isConfirmation: true,
                options: ['Sí, programa mi consulta', 'No, necesito hacer cambios']
            },
            {
                id: 'whatToChange',
                text: "¿Qué información te gustaría corregir? Selecciona todo lo que corresponda:",
                field: 'Información a Corregir',
                multiselect: true,
                options: ['Nombre Completo', 'Correo Electrónico', 'Número de Teléfono', 'Dirección', 'Código Postal', 'Fuente de Agua']
            },
            { 
                id: 'preferredDay',
                text: "¿Qué día funciona mejor para tu consulta de agua?",
                field: 'Día Preferido',
                isCalendarPicker: true,
                options: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado']
            },
            { 
                id: 'preferredTimeOfDay',
                text: "¿Qué momento del día es mejor para que nuestro técnico experto en agua te visite?",
                field: 'Momento del Día Preferido',
                options: ['Mañana', 'Tarde', 'Noche']
            },
            { 
                id: 'preferredHour',
                text: "¿Qué hora específica sería más conveniente? (Por favor escoge una hora entre las 7 AM y las 10 PM)",
                field: 'Hora Preferida',
                isClockPicker: true,
                validation: 'required'
            },
            { 
                id: 'final',
                text: "¡Gracias, {Nombre Completo}! Tu consulta gratuita de agua será verificada pronto. Uno de nuestros expertos técnicos en agua se pondrá en contacto contigo dentro de la próxima hora(s) para confirmar tu horario preferido ({Día Preferido} a las {Hora Preferida}). Hemos enviado un correo electrónico de confirmación a {Correo Electrónico} con más información sobre qué esperar y para verificar tu consulta gratuita de agua. Por favor, revisa tu correo electrónico para recibir tu Informe de Calidad del Agua Personalizado para tu área. Si tienes alguna pregunta inmediata, llámanos al (602) 721-2929.",
                field: 'Final'
            }
        ];

        // Conversation state (will be set based on language)
        let conversationId, messageHistory, formData, currentQuestion, questions;
        
        // Variables for tracking corrections
        let fieldsToCorrect = [];
        let currentCorrectionIndex = 0;
        
        // Initialize chat based on selected language
        function initializeChat(lang) {
            // Reset conversation state
            conversationId = Date.now().toString();
            messageHistory = [];
            formData = {};
            currentQuestion = 0;
            
            // Set elements and questions based on language
            if (lang === 'en') {
                chatBody = document.getElementById('chatBody');
                chatInput = document.getElementById('chatInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typingIndicator');
                questions = questionsEN;
            } else if (lang === 'es') {
                chatBody = document.getElementById('chatBodyES');
                chatInput = document.getElementById('chatInputES');
                sendButton = document.getElementById('sendButtonES');
                typingIndicator = document.getElementById('typingIndicatorES');
                questions = questionsES;
            }
            
            // Display first message from agent
            addAgentMessage(questions[0].text);
            
            // Add event listeners
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Focus the input
            chatInput.focus();
        }
        
        // Send message function
        function sendMessage() {
            const userMessage = chatInput.value.trim();
            
            // Don't send empty messages
            if (!userMessage) return;
            
            const currentQ = questions[currentQuestion];
            
            // Check if this question has options and is not multiselect, calendar or clock picker
            // If so, only allow selecting from the options, not free text entry
            if (currentQ.options && 
                !currentQ.multiselect && 
                !currentQ.isCalendarPicker && 
                !currentQ.isClockPicker) {
                
                // Check if the message matches one of the allowed options
                const isValidOption = currentQ.options.some(option => 
                    option.toLowerCase() === userMessage.toLowerCase());
                
                if (!isValidOption) {
                    // Show error message based on language
                    const errorMessage = questions === questionsEN ? 
                        "Please select one of the provided options." : 
                        "Por favor, seleccione una de las opciones proporcionadas.";
                    
                    addAgentMessage(errorMessage, null, null, true);
                    return;
                }
            }
            
            // Validate input if validation is specified
            if (currentQ.validation) {
                const validator = validators[currentQ.validation];
                if (validator) {
                    const validationResult = validator(userMessage);
                    if (!validationResult.isValid) {
                        // Show validation error message based on language
                        const errorMessage = questions === questionsEN ? 
                            validationResult.errorMessage : 
                            validationResult.errorMessageES;
                        addAgentMessage(errorMessage, null, null, true);
                        return;
                    }
                }
            }
            
            // Add user message to chat
            addUserMessage(userMessage);
            chatInput.value = '';
            
            // Store the time of day preference for later use in the clock picker
            if (currentQ.id === 'preferredTimeOfDay') {
                window.selectedTimeOfDay = userMessage;
            }
            
            // Disable all option buttons for previous questions
            disablePreviousOptions();
            
            // Process user response for current question
            const handledQuestionAdvancement = processUserResponse(userMessage, currentQ);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Move to next question or submit data
            setTimeout(() => {
                // If the response handling function already updated the currentQuestion, don't proceed with normal flow
                if (handledQuestionAdvancement) {
                    const nextQ = questions[currentQuestion];
                    
                    // If we're in correction mode, use custom correction prompts
                    let nextText = nextQ.text;
                    if (isCorrectingField()) {
                        const lang = questions === questionsEN ? 'en' : 'es';
                        nextText = getCorrectionPrompt(fieldsToCorrect[currentCorrectionIndex-1], lang);
                    } else {
                        // Replace any placeholder text with actual user input
                        for (const field in formData) {
                            nextText = nextText.replace(`{${field}}`, formData[field]);
                        }
                    }
                    
                    hideTypingIndicator();
                    addAgentMessage(nextText, nextQ.options, nextQ.multiselect);
                    return;
                }
                
                // Check if there's branch logic based on the response
                let nextQuestionId;
                if (currentQ.nextQuestionBranch && formData[currentQ.field] in currentQ.nextQuestionBranch) {
                    // Get the next question ID based on the user's response
                    nextQuestionId = currentQ.nextQuestionBranch[formData[currentQ.field]];
                    
                    // Find the index of the next question
                    const nextIndex = questions.findIndex(q => q.id === nextQuestionId);
                    if (nextIndex !== -1) {
                        currentQuestion = nextIndex;
                    } else {
                        // Fallback to sequential if branch target not found
                        currentQuestion++;
                    }
                } else {
                    // Default sequential behavior
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    const nextQ = questions[currentQuestion];
                    // Replace any placeholder text with actual user input
                    let nextText = nextQ.text;
                    for (const field in formData) {
                        nextText = nextText.replace(`{${field}}`, formData[field]);
                    }
                    hideTypingIndicator();
                    addAgentMessage(nextText, nextQ.options, nextQ.multiselect);
                } else {
                    // Send data to webhook when completed all questions
                    submitFormData();
                }
            }, 1000 + Math.random() * 1000); // Realistic typing delay
        }
        
        // Function to disable all option buttons for previous questions
        function disablePreviousOptions() {
            const optionsContainers = document.querySelectorAll('.options-container');
            
            optionsContainers.forEach(container => {
                // Check if this container is for a previous question
                if (container.dataset.questionId) {
                    const questionId = container.dataset.questionId;
                    const questionIndex = questions.findIndex(q => q.id === questionId);
                    
                    // If this is a previous question, disable its option buttons
                    if (questionIndex < currentQuestion) {
                        const optionButtons = container.querySelectorAll('.option-button');
                        optionButtons.forEach(button => {
                            button.disabled = true;
                            button.style.opacity = '0.5';
                            button.style.cursor = 'not-allowed';
                            button.style.pointerEvents = 'none'; /* Prevent any click interactions */
                            
                            // Remove event listeners by cloning and replacing
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                        });
                    }
                }
            });
        }
        
        // Process user response for a question
        function processUserResponse(response, question) {
            // Track which language we're using
            const isEnglish = questions === questionsEN;
            
            // Check for possible spelling corrections only if not correcting fields
            // This prevents incorrect language switching during corrections
            if (!isCorrectingField()) {
                const corrected = correctSpelling(response);
                
                // If we corrected something, let the user know
                if (corrected !== response) {
                    setTimeout(() => {
                        const correctionMessage = isEnglish ? 
                            `I've updated your response to: "${corrected}"` : 
                            `He actualizado tu respuesta a: "${corrected}"`;
                        addAgentMessage(correctionMessage, null, null, false, true);
                    }, 500);
                    response = corrected;
                }
            }
            
            formData[question.field] = response;
            
            // Update message history
            messageHistory.push({
                role: 'user',
                content: response,
                question: question.id
            });
            
            // Special handling for confirmation response
            if (question.id === 'confirmationSummary') {
                // Handle based on language
                const yesOption = isEnglish ? 
                    'Yes, schedule my consultation' : 
                    'Sí, programa mi consulta';
                const noOption = isEnglish ? 
                    'No, I need to make changes' : 
                    'No, necesito hacer cambios';
                
                if (response === noOption) {
                    // Reset correction tracking variables
                    fieldsToCorrect = [];
                    currentCorrectionIndex = 0;
                    
                    // Set currentQuestion to the whatToChange question
                    const whatToChangeIndex = questions.findIndex(q => q.id === 'whatToChange');
                    if (whatToChangeIndex !== -1) {
                        currentQuestion = whatToChangeIndex;
                        return true; // Signal that we've handled the question advancement
                    }
                } else if (response === yesOption) {
                    // Go to preferred day question instead of skipping to final
                    const preferredDayIndex = questions.findIndex(q => q.id === 'preferredDay');
                    if (preferredDayIndex !== -1) {
                        currentQuestion = preferredDayIndex;
                        return true; // Signal that we've handled the question advancement
                    }
                }
            }
            
            // Handle whatToChange response
            if (question.id === 'whatToChange') {
                // Parse selected fields to correct
                fieldsToCorrect = response.split(/,\s*/).map(field => field.trim());
                currentCorrectionIndex = 0;
                
                if (fieldsToCorrect.length > 0) {
                    // Set a flag indicating we're in correction mode
                    window.isInCorrectionMode = true;
                    
                    // Remember current language to maintain consistency
                    window.correctionLanguage = isEnglish ? 'en' : 'es';
                    
                    // Find the question for the first field to correct
                    for (let i = 0; i < questions.length; i++) {
                        if (questions[i].field === fieldsToCorrect[currentCorrectionIndex]) {
                            currentQuestion = i;
                            
                            // Store the current position in the survey to return later
                            window.returnToQuestionAfterCorrection = questions.findIndex(q => q.id === 'confirmationSummary');
                            
                            return true; // Signal that we've handled the question advancement
                        }
                    }
                }
            }
            
            // Handle field correction completion
            if (isCorrectingField()) {
                // Check if the current field being corrected matches the current question
                if (question.field === fieldsToCorrect[currentCorrectionIndex]) {
                    currentCorrectionIndex++;
                    
                    // If we've corrected all fields, return to the confirmation summary
                    if (currentCorrectionIndex >= fieldsToCorrect.length && window.returnToQuestionAfterCorrection) {
                        currentQuestion = window.returnToQuestionAfterCorrection;
                        fieldsToCorrect = [];
                        currentCorrectionIndex = 0;
                        window.isInCorrectionMode = false; // Reset correction mode flag
                        return true; // Signal that we've handled the question advancement
                    } else if (currentCorrectionIndex < fieldsToCorrect.length) {
                        // Move to the next field to correct
                        for (let i = 0; i < questions.length; i++) {
                            if (questions[i].field === fieldsToCorrect[currentCorrectionIndex]) {
                                currentQuestion = i;
                                return true; // Signal that we've handled the question advancement
                            }
                        }
                    }
                }
            }
            
            return false; // Signal that we haven't handled the question advancement
        }
        
        // Helper function to check if we're currently correcting fields
        function isCorrectingField() {
            return window.isInCorrectionMode === true && fieldsToCorrect && fieldsToCorrect.length > 0;
        }
        
        // Get simplified correction prompts for each field
        function getCorrectionPrompt(fieldName, language) {
            const isEnglish = language === 'en';
            
            // Safety check to prevent undefined fields
            if (!fieldName) {
                return isEnglish ? 
                    "Please correct this information:" : 
                    "Por favor, corrija esta información:";
            }
            
            // English correction prompts
            const englishPrompts = {
                'Full Name': "Please correct your full name below:",
                'Email': "Please provide the correct email address:",
                'Phone Number': "Please enter the correct phone number:",
                'Address': "Please provide the correct address including street type (St, Ave, Rd, etc.) and city:",
                'Zip Code': "Please enter the correct ZIP code:",
                'Water Source': "Please select the correct water source:",
                'Current System': "Please select the correct water filtration system you currently have:"
            };
            
            // Spanish correction prompts
            const spanishPrompts = {
                'Nombre Completo': "Por favor, corrija su nombre completo a continuación:",
                'Correo Electrónico': "Por favor, proporcione la dirección de correo electrónico correcta:",
                'Número de Teléfono': "Por favor, ingrese el número de teléfono correcto:",
                'Dirección': "Por favor, proporcione la dirección correcta incluyendo el tipo de calle y la ciudad:",
                'Código Postal': "Por favor, ingrese el código postal correcto:",
                'Fuente de Agua': "Por favor, seleccione la fuente de agua correcta:",
                'Sistema Actual': "Por favor, seleccione el sistema de filtración de agua que tiene actualmente:"
            };
            
            return isEnglish ? 
                (englishPrompts[fieldName] || `Please correct your ${fieldName}:`) : 
                (spanishPrompts[fieldName] || `Por favor, corrija su ${fieldName}:`);
        }
        
        // Submit all collected data to webhook
        function submitFormData() {
            // Disable chat input and button after final submission
            chatInput.disabled = true;
            sendButton.disabled = true;
            chatInput.placeholder = questions === questionsEN ? 
                "Chat completed. Thank you!" : 
                "Chat completado. ¡Gracias!";
            
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Origin': window.location.origin
                },
                body: JSON.stringify({
                    conversationId: conversationId,
                    formData: formData,
                    messageHistory: messageHistory,
                    triggerFollowUp: true,
                    language: questions === questionsEN ? 'en' : 'es'
                })
            })
            .then(response => {
                // Check if response exists and can be parsed as JSON
                if (response.ok) {
                    return response.json().catch(() => {
                        // If JSON parsing fails, return a default object
                        return { response: null };
                    });
                }
                // For non-OK responses, create a default object
                return { response: null };
            })
            .then(data => {
                hideTypingIndicator();
                
                // If there's a response from the webhook, display it
                if (data && data.response) {
                    addAgentMessage(data.response);
                } else {
                    // If no webhook response, display the final message from our preset messages
                    const finalMessage = questions[questions.length - 1].text;
                    let finalText = finalMessage;
                    
                    // Replace any placeholder text with actual user input
                    for (const field in formData) {
                        finalText = finalText.replace(`{${field}}`, formData[field]);
                    }
                    
                    addAgentMessage(finalText);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideTypingIndicator();
                
                // Display final message anyway even if there's an error with the webhook
                const finalMessage = questions[questions.length - 1].text;
                let finalText = finalMessage;
                
                // Replace any placeholder text with actual user input
                for (const field in formData) {
                    finalText = finalText.replace(`{${field}}`, formData[field]);
                }
                
                addAgentMessage(finalText);
            });
        }
        
        // Add agent message to chat
        function addAgentMessage(text, options, multiselect, isError = false, isCorrection = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message';
            
            const messageContent = document.createElement('div');
            if (isError) {
                messageContent.className = 'message-content error-message';
            } else if (isCorrection) {
                messageContent.className = 'message-content correction-message';
            } else {
                messageContent.className = 'message-content';
            }
            messageContent.textContent = text;
            messageDiv.appendChild(messageContent);
            
            // Get current question
            const currentQ = questions[currentQuestion];
            
            // Handle confirmation summary
            if (currentQ && currentQ.isConfirmation) {
                const confirmationSummary = document.createElement('div');
                confirmationSummary.className = 'confirmation-summary';
                
                // Add each item in a structured format based on language
                const confirmationFields = questions === questionsEN ? 
                    [
                        { label: 'Name', field: 'Full Name' },
                        { label: 'Email', field: 'Email' },
                        { label: 'Phone', field: 'Phone Number' },
                        { label: 'Address', field: 'Address' },
                        { label: 'ZIP Code', field: 'Zip Code' },
                        { label: 'Water Source', field: 'Water Source' },
                        { label: 'Current System', field: 'Current System' }
                    ] : 
                    [
                        { label: 'Nombre', field: 'Nombre Completo' },
                        { label: 'Correo', field: 'Correo Electrónico' },
                        { label: 'Teléfono', field: 'Número de Teléfono' },
                        { label: 'Dirección', field: 'Dirección' },
                        { label: 'Código Postal', field: 'Código Postal' },
                        { label: 'Fuente de Agua', field: 'Fuente de Agua' },
                        { label: 'Sistema Actual', field: 'Sistema Actual' }
                    ];
                
                confirmationFields.forEach(item => {
                    if (formData[item.field]) {
                        const confirmationItem = document.createElement('div');
                        confirmationItem.className = 'confirmation-item';
                        
                        const label = document.createElement('div');
                        label.className = 'confirmation-label';
                        label.textContent = item.label + ':';
                        
                        const value = document.createElement('div');
                        value.className = 'confirmation-value';
                        value.textContent = formData[item.field];
                        
                        confirmationItem.appendChild(label);
                        confirmationItem.appendChild(value);
                        confirmationSummary.appendChild(confirmationItem);
                    }
                });
                
                messageDiv.appendChild(confirmationSummary);
            }
            
            // Handle calendar picker for preferred day
            if (currentQ && currentQ.isCalendarPicker) {
                console.log("Creating calendar picker...");
                const calendarPicker = document.createElement('div');
                calendarPicker.className = 'calendar-picker';
                
                // Create day headers (Sun-Sat)
                const dayNames = questions === questionsEN ? 
                    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] : 
                    ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                
                dayNames.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    calendarPicker.appendChild(dayHeader);
                });
                
                // Get current date
                const today = new Date();
                // For initial week display, we don't need to adjust for current day
                
                // Create days for 2 weeks starting from today
                for (let i = 0; i < 14; i++) {
                    const futureDate = new Date();
                    futureDate.setDate(today.getDate() + i);
                    const dayOfWeek = futureDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    
                    // Calculate position in grid (for first week)
                    if (i < 7) {
                        // For first week, add empty cells before first day
                        if (i === 0) {
                            for (let j = 0; j < dayOfWeek; j++) {
                                const spacer = document.createElement('div');
                                calendarPicker.appendChild(spacer);
                            }
                        }
                        
                        // Create day button
                        const dayOption = document.createElement('div');
                        dayOption.className = 'day-option';
                        dayOption.textContent = futureDate.getDate();
                        
                        // Store the full date and day name as data attributes
                        const dayName = questions === questionsEN ? 
                            currentQ.options[dayOfWeek] : // uses the array of day names in English or Spanish
                            currentQ.options[dayOfWeek];
                        
                        const monthNames = questions === questionsEN ?
                            ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] :
                            ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                        
                        const formattedDate = `${dayName}, ${monthNames[futureDate.getMonth()]} ${futureDate.getDate()}`;
                        dayOption.dataset.fullDate = formattedDate;
                        dayOption.dataset.dayName = dayName;
                        
                        dayOption.addEventListener('click', () => {
                            // Remove selected class from all options
                            document.querySelectorAll('.day-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            
                            // Add selected class to clicked option
                            dayOption.classList.add('selected');
                            
                            // Set the input value to the full date
                            chatInput.value = formattedDate;
                            
                            // Focus the input after selecting a date
                            chatInput.focus();
                        });
                        
                        calendarPicker.appendChild(dayOption);
                    }
                }
                
                messageDiv.appendChild(calendarPicker);
            }
            
            // Handle clock picker for preferred hour
            if (currentQ && currentQ.isClockPicker) {
                console.log("Creating clock picker...");
                const clockPicker = document.createElement('div');
                clockPicker.className = 'clock-picker';
                
                // Get preferred time of day if set
                const preferredTimeOfDay = window.selectedTimeOfDay || '';
                console.log("Preferred time of day:", preferredTimeOfDay);
                
                // Create hour options (7 AM to 10 PM)
                const hours = [];
                for (let i = 7; i <= 12; i++) {
                    hours.push(i);
                }
                for (let i = 1; i <= 10; i++) {
                    hours.push(i);
                }
                
                // Determine which hours to suggest based on time of day
                const isMorning = preferredTimeOfDay.includes('Morning') || preferredTimeOfDay.includes('Mañana');
                const isAfternoon = preferredTimeOfDay.includes('Afternoon') || preferredTimeOfDay.includes('Tarde');
                const isEvening = preferredTimeOfDay.includes('Evening') || preferredTimeOfDay.includes('Noche');
                
                // Create hour elements
                hours.forEach(hour => {
                    const timeOption = document.createElement('div');
                    timeOption.className = 'time-option';
                    timeOption.textContent = hour;
                    
                    // Add suggested class based on time of day preference
                    if (isMorning && ((hour >= 7 && hour <= 11))) {
                        timeOption.classList.add('suggested');
                    } else if (isAfternoon && ((hour >= 12 || hour <= 5))) {
                        timeOption.classList.add('suggested');
                    } else if (isEvening && ((hour >= 6 && hour <= 10))) {
                        timeOption.classList.add('suggested');
                    }
                    
                    timeOption.addEventListener('click', () => {
                        // Remove selected class from all hour options
                        document.querySelectorAll('.time-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked option
                        timeOption.classList.add('selected');
                        
                        // Determine default period based on time of day and hour
                        let defaultPeriod = '';
                        if (isMorning) {
                            defaultPeriod = 'AM';
                        } else if (isAfternoon || isEvening) {
                            defaultPeriod = 'PM';
                        } else {
                            // No preference - make a reasonable guess
                            defaultPeriod = (hour >= 7 && hour <= 11) ? 'AM' : 'PM';
                        }
                        
                        // Get the selected period (AM/PM) or use default
                        const selectedPeriod = document.querySelector('.period-option.selected');
                        if (selectedPeriod) {
                            // Set the input value to the full time
                            chatInput.value = `${hour} ${selectedPeriod.textContent}`;
                        } else {
                            // Auto-select the appropriate period based on time of day
                            const periodToSelect = document.querySelector(`.period-option[data-period="${defaultPeriod}"]`);
                            if (periodToSelect) {
                                periodToSelect.classList.add('selected');
                                chatInput.value = `${hour} ${defaultPeriod}`;
                            }
                        }
                        
                        // Focus the input after selecting a time
                        chatInput.focus();
                    });
                    
                    clockPicker.appendChild(timeOption);
                });
                
                // Add AM/PM options
                const timePeriod = document.createElement('div');
                timePeriod.className = 'time-period';
                
                const amOption = document.createElement('div');
                amOption.className = 'period-option';
                amOption.textContent = 'AM';
                amOption.dataset.period = 'AM';
                
                // Set AM as default selected for morning
                if (isMorning) {
                    amOption.classList.add('selected');
                }
                
                amOption.addEventListener('click', () => {
                    // Remove selected class from PM
                    document.querySelector('.period-option:nth-child(2)').classList.remove('selected');
                    
                    // Add selected class to AM
                    amOption.classList.add('selected');
                    
                    // Get the selected hour
                    const selectedHour = document.querySelector('.time-option.selected');
                    if (selectedHour) {
                        // Set the input value to the full time
                        chatInput.value = `${selectedHour.textContent} AM`;
                        // Focus the input after selecting AM/PM
                        chatInput.focus();
                    }
                });
                
                const pmOption = document.createElement('div');
                pmOption.className = 'period-option';
                pmOption.textContent = 'PM';
                pmOption.dataset.period = 'PM';
                
                // Set PM as default selected for afternoon/evening
                if (isAfternoon || isEvening) {
                    pmOption.classList.add('selected');
                }
                
                pmOption.addEventListener('click', () => {
                    // Remove selected class from AM
                    document.querySelector('.period-option:first-child').classList.remove('selected');
                    
                    // Add selected class to PM
                    pmOption.classList.add('selected');
                    
                    // Get the selected hour
                    const selectedHour = document.querySelector('.time-option.selected');
                    if (selectedHour) {
                        // Set the input value to the full time
                        chatInput.value = `${selectedHour.textContent} PM`;
                        // Focus the input after selecting AM/PM
                        chatInput.focus();
                    }
                });
                
                timePeriod.appendChild(amOption);
                timePeriod.appendChild(pmOption);
                clockPicker.appendChild(timePeriod);
                
                // Add helper text explaining the suggestions
                if (preferredTimeOfDay) {
                    const hintText = questions === questionsEN ? 
                        `Based on your preference for ${preferredTimeOfDay}, we've highlighted suggested times, but you can select any time that works for you.` : 
                        `Basado en tu preferencia por ${preferredTimeOfDay}, hemos resaltado los horarios sugeridos, pero puedes seleccionar cualquier horario que te convenga.`;
                    
                    const suggestionHint = document.createElement('div');
                    suggestionHint.className = 'time-suggestion-hint';
                    suggestionHint.textContent = hintText;
                    clockPicker.appendChild(suggestionHint);
                }
                
                messageDiv.appendChild(clockPicker);
            }
            
            // Add options if provided (for multiple choice questions)
            if (options && options.length && !currentQ.isCalendarPicker && !currentQ.isClockPicker) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                // Add a unique ID to this options container for the current question
                optionsContainer.dataset.questionId = currentQ.id;
                
                options.forEach(option => {
                    const optionButton = document.createElement('button');
                    optionButton.className = 'option-button';
                    optionButton.textContent = option;
                    optionButton.addEventListener('click', () => {
                        if (multiselect) {
                            // For multiselect, collect options in input field
                            if (chatInput.value) {
                                if (!chatInput.value.includes(option)) {
                                    chatInput.value += ', ' + option;
                                }
                            } else {
                                chatInput.value = option;
                            }
                            // Focus the input after selecting an option
                            chatInput.focus();
                        } else {
                            // For single select, immediately submit the option
                            chatInput.value = option;
                            sendMessage();
                        }
                    });
                    optionsContainer.appendChild(optionButton);
                });
                
                messageDiv.appendChild(optionsContainer);
            }
            
            chatBody.appendChild(messageDiv);
            scrollToBottom();
            
            // Auto-focus the input field after showing a new message
            if (!options || options.length === 0) {
                chatInput.focus();
            }
            
            // Immediately disable options from previous questions to prevent interaction
            disablePreviousOptions();
        }
        
        // Add user message to chat
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = text;
            messageDiv.appendChild(messageContent);
            
            chatBody.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // Scroll chat to bottom
        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    </script>
    
    <!-- Mobile fixes script - Ensures proper display on iOS/mobile devices -->
    <script>
        // Fix for iOS 100vh issue
        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Pre-initialize sidebars function
        function initializeSidebars() {
            console.log("Initializing sidebars...");
            const sidebars = document.querySelectorAll('.sidebar');
            if (sidebars.length > 0) {
                console.log("Found " + sidebars.length + " sidebars");
                // Make sidebars visible for initialization
                sidebars.forEach(sidebar => {
                    // Store original display value
                    const originalDisplay = sidebar.style.display;
                    // Make temporarily visible if needed
                    sidebar.style.display = 'flex';
                    
                    // Apply all sidebar styling
                    sidebar.style.background = 'linear-gradient(135deg, var(--primary-color), var(--primary-dark))';
                    sidebar.style.color = '#FFFFFF';
                    sidebar.style.width = '38%';
                    sidebar.style.minWidth = '300px';
                    sidebar.style.flex = '0 0 38%';
                    sidebar.style.padding = '2rem';
                    sidebar.style.position = 'relative';
                    sidebar.style.overflow = 'hidden';
                    
                    // Apply styling to sidebar content
                    const sidebarContent = sidebar.querySelector('.sidebar-content');
                    if (sidebarContent) {
                        sidebarContent.style.position = 'relative';
                        sidebarContent.style.zIndex = '1';
                        sidebarContent.style.height = '100%';
                        sidebarContent.style.display = 'flex';
                        sidebarContent.style.flexDirection = 'column';
                    }
                    
                    // Apply styling to features section
                    const features = sidebar.querySelector('.features');
                    if (features) {
                        features.style.marginTop = 'auto';
                        features.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                        features.style.padding = '1.2rem';
                        features.style.borderRadius = '12px';
                        features.style.borderLeft = '3px solid var(--secondary-color)';
                        features.style.display = 'block';
                    }
                    
                    // Restore original display if needed
                    if (originalDisplay) {
                        sidebar.style.display = originalDisplay;
                    }
                });
            }
        }
        
        // Force sidebar consistent appearance for both languages
        function fixSidebarHeight() {
            // Ensure the sidebar layout is consistent across both language versions
            const sidebars = document.querySelectorAll('.sidebar');
            sidebars.forEach(sidebar => {
                sidebar.style.minHeight = '150px';
                sidebar.style.maxHeight = 'none'; // Remove height restriction
                sidebar.style.height = 'auto'; // Let it take natural height
                sidebar.style.minWidth = '300px'; // Ensure minimum width
                sidebar.style.width = '38%'; // Match CSS width
                sidebar.style.flex = '0 0 38%'; // Prevent shrinking
                
                // Ensure the sidebar background and textures are applied
                sidebar.style.background = 'linear-gradient(135deg, var(--primary-color), var(--primary-dark))';
                sidebar.style.position = 'relative';
                sidebar.style.overflow = 'hidden';
                sidebar.style.display = 'flex';
                sidebar.style.flexDirection = 'column';
                sidebar.style.padding = '2rem';
                
                // Make sure the pseudo-elements are properly styled
                // We need to add these manually since we can't directly style pseudo-elements with JS
                if (!sidebar.querySelector('.sidebar-overlay-texture')) {
                    const textureOverlay = document.createElement('div');
                    textureOverlay.className = 'sidebar-overlay-texture';
                    textureOverlay.style.position = 'absolute';
                    textureOverlay.style.top = '0';
                    textureOverlay.style.left = '0';
                    textureOverlay.style.width = '100%';
                    textureOverlay.style.height = '100%';
                    textureOverlay.style.backgroundImage = 'var(--wood-texture)';
                    textureOverlay.style.opacity = '0.05';
                    textureOverlay.style.zIndex = '0';
                    sidebar.appendChild(textureOverlay);
                }
                
                if (!sidebar.querySelector('.sidebar-overlay-gradient')) {
                    const gradientOverlay = document.createElement('div');
                    gradientOverlay.className = 'sidebar-overlay-gradient';
                    gradientOverlay.style.position = 'absolute';
                    gradientOverlay.style.top = '-50%';
                    gradientOverlay.style.left = '-50%';
                    gradientOverlay.style.width = '200%';
                    gradientOverlay.style.height = '200%';
                    gradientOverlay.style.background = 'radial-gradient(ellipse at center, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%)';
                    gradientOverlay.style.transform = 'rotate(20deg)';
                    gradientOverlay.style.zIndex = '0';
                    sidebar.appendChild(gradientOverlay);
                }
            });
            
            // Force visibility of logo and tagline on mobile
            const logos = document.querySelectorAll('.logo');
            const taglines = document.querySelectorAll('.tagline');
            const descriptions = document.querySelectorAll('.description');
            const featuresElements = document.querySelectorAll('.features');
            
            logos.forEach(logo => {
                logo.style.display = 'block';
                logo.style.textShadow = '1px 1px 3px rgba(0, 0, 0, 0.2)';
                logo.style.letterSpacing = '0.5px';
                logo.style.fontSize = '2rem';
                logo.style.fontWeight = '700';
                logo.style.marginBottom = '2rem';
            });
            
            taglines.forEach(tagline => {
                tagline.style.display = 'block';
                tagline.style.textShadow = '1px 1px 3px rgba(0, 0, 0, 0.15)';
                tagline.style.fontSize = '2.2rem';
                tagline.style.fontWeight = '700';
                tagline.style.lineHeight = '1.3';
                tagline.style.marginBottom = '1.5rem';
            });
            
            descriptions.forEach(desc => {
                desc.style.display = 'block';
                desc.style.fontSize = '1.1rem';
                desc.style.fontWeight = '400';
                desc.style.lineHeight = '1.6';
                desc.style.marginBottom = '2rem';
                desc.style.letterSpacing = '0.2px';
            });
            
            featuresElements.forEach(feature => {
                feature.style.display = 'block';
                feature.style.marginTop = 'auto';
                feature.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                feature.style.padding = '1.2rem';
                feature.style.borderRadius = '12px';
                feature.style.borderLeft = '3px solid var(--secondary-color)';
            });
            
            // Ensure sidebar content is above overlays
            const sidebarContents = document.querySelectorAll('.sidebar-content');
            sidebarContents.forEach(content => {
                content.style.position = 'relative';
                content.style.zIndex = '1';
                content.style.height = '100%';
                content.style.display = 'flex';
                content.style.flexDirection = 'column';
            });
            
            // Style feature boxes with rustic elements
            const featureItems = document.querySelectorAll('.feature');
            featureItems.forEach(item => {
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.marginBottom = '1rem';
            });
            
            const featureIcons = document.querySelectorAll('.feature-icon');
            featureIcons.forEach(icon => {
                icon.style.background = 'rgba(255, 255, 255, 0.2)';
                icon.style.width = '36px';
                icon.style.height = '36px';
                icon.style.borderRadius = '50%';
                icon.style.display = 'flex';
                icon.style.alignItems = 'center';
                icon.style.justifyContent = 'center';
                icon.style.marginRight = '1rem';
                icon.style.flexShrink = '0';
                icon.style.border = '1px solid rgba(255, 255, 255, 0.3)';
            });
            
            const featureTexts = document.querySelectorAll('.feature-text');
            featureTexts.forEach(text => {
                text.style.fontSize = '0.9rem';
                text.style.wordWrap = 'break-word';
                text.style.overflowWrap = 'break-word';
            });
        }
        
        // Run when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial height
            setVH();
            
            // Make scrollable areas work properly on iOS
            document.querySelectorAll('.chat-body, .sidebar-content').forEach(el => {
                el.style.webkitOverflowScrolling = 'touch';
            });
            
            // Initialize sidebars immediately
            initializeSidebars();
            
            // Call immediately and on resize
            fixSidebarHeight();
            window.addEventListener('resize', fixSidebarHeight);
            
            // Fix for iPhone layout issues - force proper display of container structure
            function fixIPhoneLayout() {
                // Check if it's an iPhone
                const isIPhone = /iPhone/.test(navigator.userAgent);
                if (isIPhone) {
                    // Get the container and adjust its layout
                    const containers = document.querySelectorAll('.container');
                    containers.forEach(container => {
                        // Set explicit height and ensure flex column layout
                        container.style.display = 'flex';
                        container.style.flexDirection = 'column';
                        container.style.height = '100%';
                        container.style.maxHeight = '100vh';
                        container.style.overflowY = 'auto';
                        
                        // Make sidebar much less prominent on iPhone
                        const sidebar = container.querySelector('.sidebar');
                        if (sidebar) {
                            sidebar.style.maxHeight = '30vh'; // Reduce from 50vh to 30vh
                            sidebar.style.flex = '0 0 auto';
                            sidebar.style.padding = '1rem'; // Reduce padding
                            
                            // Make sidebar content more compact
                            const logo = sidebar.querySelector('.logo');
                            if (logo) {
                                logo.style.fontSize = '1.5rem';
                                logo.style.marginBottom = '0.5rem';
                            }
                            
                            const tagline = sidebar.querySelector('.tagline');
                            if (tagline) {
                                tagline.style.fontSize = '1.2rem';
                                tagline.style.marginBottom = '0.5rem';
                            }
                            
                            const description = sidebar.querySelector('.description');
                            if (description) {
                                description.style.fontSize = '0.9rem';
                                description.style.marginBottom = '0.5rem';
                            }
                            
                            // Hide features section completely on iPhone to save space
                            const features = sidebar.querySelector('.features');
                            if (features) {
                                features.style.display = 'none';
                            }
                        }
                        
                        // Make chat container (survey form) much more prominent
                        const chatContainer = container.querySelector('.chat-container');
                        if (chatContainer) {
                            chatContainer.style.flex = '1 1 auto';
                            chatContainer.style.display = 'flex';
                            chatContainer.style.flexDirection = 'column';
                            chatContainer.style.minHeight = '70vh'; // Increase from 50vh to 70vh
                            
                            // Enhance chat header visibility
                            const chatHeader = chatContainer.querySelector('.chat-header');
                            if (chatHeader) {
                                chatHeader.style.backgroundColor = '#ffffff';
                                chatHeader.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                                chatHeader.style.position = 'sticky';
                                chatHeader.style.top = '0';
                                chatHeader.style.zIndex = '10';
                            }
                            
                            // Make sure chat body takes available space and is clearly visible
                            const chatBody = chatContainer.querySelector('.chat-body');
                            if (chatBody) {
                                chatBody.style.flex = '1 1 auto';
                                chatBody.style.backgroundColor = '#ffffff';
                                chatBody.style.paddingTop = '1rem';
                            }
                            
                            // Make chat input area more prominent
                            const chatInputContainer = chatContainer.querySelector('.chat-input-container');
                            if (chatInputContainer) {
                                chatInputContainer.style.backgroundColor = '#ffffff';
                                chatInputContainer.style.boxShadow = '0 -2px 4px rgba(0,0,0,0.1)';
                                chatInputContainer.style.padding = '1rem';
                            }
                        }
                    });
                    
                    // Force body to allow scrolling
                    document.body.style.overflow = 'auto';
                    document.body.style.height = 'auto';
                    document.documentElement.style.overflow = 'auto';
                    document.documentElement.style.height = 'auto';
                    
                    // Scroll down slightly to focus on the chat container
                    setTimeout(function() {
                        window.scrollTo(0, window.innerHeight * 0.25); // Scroll down 25% of viewport height
                    }, 300);
                }
            }
            
            // Run iPhone fixes immediately and on resize/orientation change
            fixIPhoneLayout();
            window.addEventListener('resize', fixIPhoneLayout);
            window.addEventListener('orientationchange', function() {
                setTimeout(fixIPhoneLayout, 100);
            });
            
            // Improve touch handling on mobile
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                // Extra fixes for iOS
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    // Force correct height calculations
                    setVH();
                    window.addEventListener('resize', setVH);
                    window.addEventListener('scroll', setVH);
                    
                    // Fix for scrolling issues on iOS
                    document.querySelectorAll('.chat-body').forEach(el => {
                        el.style.webkitOverflowScrolling = 'touch';
                        
                        // Fix for iOS momentum scrolling
                        el.addEventListener('touchstart', function() {
                            const top = this.scrollTop;
                            const totalScroll = this.scrollHeight;
                            const currentScroll = top + this.offsetHeight;
                            
                            if (top === 0) {
                                this.scrollTop = 1;
                            } else if (currentScroll === totalScroll) {
                                this.scrollTop = top - 1;
                            }
                        });
                    });
                }
                
                // Special mobile sidebar handling
                function adjustSidebarForMobile() {
                    const sidebars = document.querySelectorAll('.sidebar');
                    if (window.innerWidth <= 768) {
                        // Mobile view
                        sidebars.forEach(sidebar => {
                            sidebar.style.width = '100%';
                            sidebar.style.minWidth = '100%';
                            sidebar.style.flex = '1 0 auto';
                            sidebar.style.height = 'auto';
                            sidebar.style.maxHeight = '60vh'; // Match the CSS max-height
                            sidebar.style.overflowY = 'auto'; // Allow scrolling within sidebar
                            
                            // Adjust content for mobile
                            const tagline = sidebar.querySelector('.tagline');
                            if (tagline) {
                                tagline.style.fontSize = '1.5rem';
                            }
                            
                            // Show features but keep compact
                            const features = sidebar.querySelector('.features');
                            if (features) {
                                features.style.display = 'block';
                                features.style.marginBottom = '1rem';
                                features.style.padding = '0.8rem';
                            }
                        });
                        
                        // Ensure chat container is visible
                        const chatContainers = document.querySelectorAll('.chat-container');
                        chatContainers.forEach(container => {
                            container.style.height = 'auto';
                            container.style.minHeight = '40vh';
                            container.style.display = 'flex';
                        });
                        
                        // Make content containers scrollable
                        const contentContainers = document.querySelectorAll('.content-container.visible');
                        contentContainers.forEach(container => {
                            container.style.height = '100%';
                            container.style.overflowY = 'auto';
                            container.style.WebkitOverflowScrolling = 'touch';
                        });
                    } else {
                        // Desktop view
                        sidebars.forEach(sidebar => {
                            sidebar.style.width = '38%';
                            sidebar.style.minWidth = '300px';
                            sidebar.style.flex = '0 0 38%';
                            sidebar.style.maxHeight = 'none';
                            
                            // Restore features visibility
                            const features = sidebar.querySelector('.features');
                            if (features) {
                                features.style.display = 'block';
                                features.style.marginBottom = '0';
                                features.style.padding = '1.2rem';
                            }
                        });
                        
                        // Reset chat container styles
                        const chatContainers = document.querySelectorAll('.chat-container');
                        chatContainers.forEach(container => {
                            container.style.height = '';
                            container.style.minHeight = '';
                        });
                    }
                }
                
                // Call immediately and on resize
                adjustSidebarForMobile();
                window.addEventListener('resize', adjustSidebarForMobile);
                window.addEventListener('orientationchange', function() {
                    setTimeout(adjustSidebarForMobile, 100);
                });
                
                // Fix for option buttons, day options, and time options
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('option-button') || 
                        e.target.classList.contains('day-option') || 
                        e.target.classList.contains('time-option') ||
                        e.target.classList.contains('period-option')) {
                        
                        // Create a visual feedback effect
                        e.target.style.opacity = '0.7';
                        setTimeout(() => {
                            e.target.style.opacity = '1';
                        }, 150);
                    }
                });
                
                // Fix for iOS keyboard hiding input
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // Scroll to make input visible when focused
                        setTimeout(() => {
                            const chatBody = this.closest('.chat-container')?.querySelector('.chat-body');
                            if (chatBody) {
                                chatBody.scrollTop = chatBody.scrollHeight;
                            }
                            
                            // Hide sidebar when keyboard appears (saves space)
                            if (window.innerHeight < 500) {
                                const sidebar = document.querySelector('.sidebar');
                                if (sidebar) {
                                    sidebar.style.display = 'none';
                                }
                            }
                        }, 300);
                    });
                    
                    // Restore sidebar when input is blurred
                    input.addEventListener('blur', function() {
                        setTimeout(() => {
                            if (window.innerHeight >= 500) {
                                const sidebar = document.querySelector('.sidebar');
                                if (sidebar) {
                                    sidebar.style.display = 'flex';
                                    adjustSidebarForMobile(); // Re-apply mobile styling
                                }
                            }
                        }, 300);
                    });
                });
            }
        });
        
        // Update on resize and orientation change
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', function() {
            // Small delay to ensure orientation change is complete
            setTimeout(setVH, 100);
            setTimeout(setVH, 500); // Additional call to handle iOS orientation change delay
        });
    </script>
</body>
</html> 